<?xml version="1.0" encoding="UTF-8"?>
<root BTCPP_format="4"
      main_tree_to_execute="Untitled">
  <BehaviorTree ID="Untitled">
    <Sequence>
      <Sequence>
        <SetBlackboard value="False"
                       output_key="has_equipments"/>
        <SetBlackboard value="True"
                       output_key="is_room_free"/>
        <SetBlackboard value="0.0"
                       output_key="recharge_x"/>
        <SetBlackboard value="0.0"
                       output_key="recharge_y"/>
        <SetBlackboard value="0.0"
                       output_key="room_x"/>
        <SetBlackboard value="-3.0"
                       output_key="room_y"/>
        <SetBlackboard value="-1.0"
                       output_key="storage_x"/>
        <SetBlackboard value="1.0"
                       output_key="storage_y"/>
      </Sequence>
      <StationUndock/>
      <Fallback>
        <Sequence name="Mission">
          <IsRoomFree is_room_free="{is_room_free}"/>
          <SetBlackboard value="False"
                         output_key="is_room_free"/>
          <ReactiveSequence>
            <TimeToComplete ttc="{ttc}"/>
            <Fallback name="Checking Battery">
              <CheckBattery/>
              <Sequence>
                <StationDock/>
                <RetryUntilSuccessful num_attempts="30">
                  <Sequence>
                    <Sleep msec="1000"/>
                    <CheckBattery/>
                  </Sequence>
                </RetryUntilSuccessful>
                <StationUndock/>
              </Sequence>
            </Fallback>
            <Fallback name="Cheking Equipments">
              <CheckEquipments has_equipments="{has_equipments}"/>
              <Sequence>
                <GoToDestination name="Go To Storage"
                                 x="{storage_x}"
                                 y="{storage_y}"/>
                <PickEquipments has_equipments="{has_equipments}"/>
              </Sequence>
            </Fallback>
            <Sequence>
              <GoToDestination name="Go to Room"
                               x="{room_x}"
                               y="{room_y}"/>
              <Sequence name="Room Tasks">
                <Fallback>
                  <MoveFurniture/>
                  <SendMessageToManager message="fail: move furniture"/>
                </Fallback>
                <Fallback>
                  <VacuumFloor/>
                  <SendMessageToManager message="fail: Vacuum floor"/>
                </Fallback>
                <Fallback>
                  <WipeFloor/>
                  <SendMessageToManager message="fail: wipe floor"/>
                </Fallback>
                <Fallback>
                  <SterilizeFurniture/>
                  <SendMessageToManager message="fail: Sterilize furniture"/>
                </Fallback>
              </Sequence>
            </Sequence>
          </ReactiveSequence>
          <GoToDestination name="Go To Recharge Station"
                           x="{recharge_x}"
                           y="{recharge_y}"/>
          <StationDock/>
          <SetBlackboard value="True"
                         output_key="is_room_free"/>
        </Sequence>
        <Sequence>
          <SendMessageToManager message="fail: Mission aborted"/>
          <AbortMission/>
          <AlwaysFailure/>
        </Sequence>
      </Fallback>
    </Sequence>
  </BehaviorTree>

  <!-- Description of Node Models (used by Groot) -->
  <TreeNodesModel>
    <Action ID="AbortMission"
            editable="true"/>
    <Condition ID="CheckBattery"
               editable="true"/>
    <Condition ID="CheckEquipments"
               editable="true">
      <input_port name="has_equipments"/>
    </Condition>
    <Action ID="GoToDestination"
            editable="true">
      <input_port name="x"/>
      <input_port name="y"/>
    </Action>
    <Condition ID="IsRoomFree"
               editable="true">
      <input_port name="is_room_free"/>
    </Condition>
    <Action ID="MoveFurniture"
            editable="true"/>
    <Action ID="PickEquipments"
            editable="true">
      <output_port name="has_equipments"/>
    </Action>
    <Action ID="SendMessageToManager"
            editable="true">
      <input_port name="message"/>
    </Action>
    <Action ID="StationDock"
            editable="true"/>
    <Action ID="StationUndock"
            editable="true"/>
    <Action ID="SterilizeFurniture"
            editable="true"/>
    <Action ID="TimeToComplete"
            editable="true">
      <output_port name="ttc"/>
    </Action>
    <Action ID="VacuumFloor"
            editable="true"/>
    <Action ID="WipeFloor"
            editable="true"/>
  </TreeNodesModel>

</root>
